<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
    <title>Document</title>
    <style>
      canvas {
        transform-origin: top left;
        image-rendering: pixelated;
      }
      .bg {
        height: 500px;
        overflow: hidden;
        position: relative;
      }
      i{
        position: absolute;
        top: 10px;
        left: 10px;
        font-size: 30px;
        color: green;
        filter: drop-shadow(0 0 6px black);
        cursor: pointer;
      }
      i:active{
        color: white;
      }
    </style>
  </head>
  <body>
    <input type="file" name="" id="" />
    <script>
      let noOfImages = 6;
      const imgHeight = 500;
      const margin = 40;
      const imagesCont = document.getElementById("images-cont");
      function fit(img) {
        let scale = imgHeight / img.height;
        img.style.transform = `scale(${scale})`;
      }
      for (let i = 0; i < 5; i++) {
        let canvas = document.createElement("canvas");
        let ctx = canvas.getContext("2d");
        let img = new Image();
        img.src = `img${i}.png`;
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0, img.width, img.height);
          let tempDiv = document.createElement("div");
          tempDiv.appendChild(canvas);
          tempDiv.classList.add("bg");
          let downloadBtn = document.createElement("i")
          downloadBtn.classList.add("bi", "bi-cloud-arrow-down-fill");
          downloadBtn.onclick = () => {
            let a = document.createElement("a")
            a.href = canvas.toDataURL()
            a.download = `img${i}.png`
            a.click()
          }
          tempDiv.appendChild(downloadBtn)
          fit(canvas);
          document.body.appendChild(tempDiv);
        };
      }
      const input = document.querySelector("input");
      input.onchange = () => {
        const file = input.files[0];
        let img = new Image()
        img.src = URL.createObjectURL(file)
        img.onload = () => {
          let bgs = document.querySelectorAll(".bg");
          bgs.forEach((item) => {
            let canvas = item.firstElementChild
            let img1 = new Image()
            let ctx = canvas.getContext("2d")
            img1.src = canvas.toDataURL()
            let rect = findTransparentCorners(canvas)
            console.log(rect);
            let scale = 1
            ctx.drawImage(img, rect.left - margin * scale, rect.top - margin * scale, rect.right - rect.left + margin*scale*2, rect.bottom - rect.top + margin*scale*2)
            img1.onload = () => {
              ctx.drawImage(img1, 0, 0, img1.width, img1.height)
            }
          });
        }
      };

      function findTransparentCorners(canvas) {
        canvas.toBlob(blob => console.log(URL.createObjectURL(blob)))
        const context = canvas.getContext("2d");
        // Get the image data
        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        let centerHorizontalPixel = (canvas.height * 4) / 2;
        let centerVerticalPixel = (canvas.height / 2) * canvas.width * 4;
        let top = null;
        let bottom = null;
        let left = null;
        let right = null;
        for (let i = 0; i < canvas.height; i++) {
          let temp = i * canvas.width * 4 + centerHorizontalPixel;
          if (data[temp + 3] == 0) {
            if (!top) {
              top = i;
            } else {
              bottom = i;
            }
          }
        }
        for (let i = centerVerticalPixel; i < centerVerticalPixel + canvas.width * 4; i += 4) {
          // console.log(data[i], data[i + 1], data[i + 2], data[i + 3]);
          if (data[i + 3] == 0) {
            if (!left) {
              left = (i - centerVerticalPixel) / 4;
            } else {
              right = (i - centerVerticalPixel) / 4;
            }
          }
        }
        return {
          top: top,
          right: right,
          left: left,
          bottom: bottom,
        };
      }
    </script>
  </body>
</html>
